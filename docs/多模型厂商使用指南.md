# 多模型厂商使用指南

本文档介绍如何在FastAPI AI聊天应用中使用多个AI模型厂商。

## 🎯 支持的AI提供商

### 1. OpenAI
- **模型**: GPT-3.5-turbo, GPT-4等
- **特点**: 强大的对话能力，广泛应用
- **配置**: 需要OpenAI API密钥

### 2. Claude (Anthropic)
- **模型**: Claude-3-sonnet, Claude-3-haiku等
- **特点**: 安全性高，推理能力强
- **配置**: 需要Anthropic API密钥

### 3. 通义千问 (阿里云)
- **模型**: qwen-turbo, qwen-plus等
- **特点**: 中文理解优秀，本土化支持
- **配置**: 需要阿里云DashScope API密钥

### 4. 文心一言 (百度)
- **模型**: ernie-bot-turbo, ernie-bot等
- **特点**: 中文语言模型，百度生态
- **配置**: 需要百度智能云API密钥和Secret密钥

## ⚙️ 配置方法

### 环境变量配置

在 `.env` 文件中配置所需的AI提供商：

```env
# 设置默认提供商
DEFAULT_AI_PROVIDER=openai

# OpenAI配置
OPENAI_API_KEY=sk-xxx
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-3.5-turbo
OPENAI_MAX_TOKENS=1000
OPENAI_TEMPERATURE=0.7

# Claude配置
CLAUDE_API_KEY=sk-ant-xxx
CLAUDE_BASE_URL=https://api.anthropic.com
CLAUDE_MODEL=claude-3-sonnet-20240229
CLAUDE_MAX_TOKENS=1000
CLAUDE_TEMPERATURE=0.7

# 通义千问配置
QIANWEN_API_KEY=sk-xxx
QIANWEN_BASE_URL=https://dashscope.aliyuncs.com/api/v1
QIANWEN_MODEL=qwen-turbo
QIANWEN_MAX_TOKENS=1000
QIANWEN_TEMPERATURE=0.7

# 文心一言配置
WENXIN_API_KEY=xxx
WENXIN_SECRET_KEY=xxx
WENXIN_BASE_URL=https://aip.baidubce.com
WENXIN_MODEL=ernie-bot-turbo
WENXIN_MAX_TOKENS=1000
WENXIN_TEMPERATURE=0.7
```

### 注意事项

1. **至少配置一个提供商**: 系统要求至少配置一个AI提供商的API密钥
2. **默认提供商**: 如果未指定或配置无效，系统会自动选择第一个可用的提供商
3. **API密钥安全**: 请妥善保管API密钥，不要提交到版本控制系统

## 🚀 使用方法

### 1. 获取可用提供商列表

```bash
curl -X GET "http://localhost:8000/providers"
```

响应示例：
```json
{
  "providers": [
    {
      "id": "openai",
      "name": "OpenAI",
      "models": ["gpt-3.5-turbo", "gpt-4"],
      "is_default": true
    },
    {
      "id": "claude",
      "name": "Claude",
      "models": ["claude-3-sonnet-20240229"],
      "is_default": false
    }
  ],
  "default_provider": "openai",
  "all_models": {
    "openai": ["gpt-3.5-turbo", "gpt-4"],
    "claude": ["claude-3-sonnet-20240229"]
  }
}
```

### 2. 使用指定提供商进行对话

#### 流式聊天（指定提供商）

```bash
curl -X GET "http://localhost:8000/chat/stream?user_id=user123&session_id=session456&message=你好&role=assistant&provider=claude"
```

#### 参数说明

- `provider`: 可选参数，指定AI提供商（openai、claude、qianwen、wenxin）
- 如果不指定 `provider`，将使用默认提供商
- 如果指定的提供商不可用，系统会回退到默认提供商

### 3. 前端集成示例

```javascript
// 获取可用提供商
fetch('/providers')
  .then(response => response.json())
  .then(data => {
    console.log('可用提供商:', data.providers);
  });

// 使用指定提供商发送消息
const eventSource = new EventSource(
  `/chat/stream?user_id=user123&session_id=session456&message=你好&provider=claude`
);

eventSource.onmessage = function(event) {
  const data = JSON.parse(event.data);
  if (data.content) {
    console.log('AI响应:', data.content);
  }
};
```

## 🔧 扩展新的AI提供商

### 1. 创建提供商实现类

在 `ai_providers/` 目录下创建新的提供商实现：

```python
from .base import BaseAIProvider, AIMessage, AIResponse
from typing import List, Dict, Any, AsyncGenerator

class NewAIProvider(BaseAIProvider):
    """新AI提供商实现"""
    
    def __init__(self, config: Dict[str, Any]):
        super().__init__(config)
        # 初始化客户端
        
    def generate_response(self, messages: List[AIMessage]) -> AIResponse:
        """生成同步响应"""
        # 实现同步响应生成逻辑
        pass
        
    async def generate_streaming_response(self, messages: List[AIMessage]) -> AsyncGenerator[AIResponse, None]:
        """生成流式响应"""
        # 实现流式响应生成逻辑
        pass
        
    def validate_config(self) -> bool:
        """验证配置"""
        # 验证必需的配置项
        pass
        
    def get_available_models(self) -> List[str]:
        """获取可用模型列表"""
        # 返回支持的模型列表
        pass
        
    def get_provider_name(self) -> str:
        """获取提供商名称"""
        return "NewAI"
```

### 2. 注册新提供商

在 `ai_providers/factory.py` 中注册新提供商：

```python
from .new_ai_provider import NewAIProvider

# 在AIProviderFactory类中添加
PROVIDERS = {
    "openai": OpenAIProvider,
    "claude": ClaudeProvider,
    "qianwen": QianwenProvider,
    "wenxin": WenxinProvider,
    "newai": NewAIProvider,  # 新增
}
```

### 3. 添加配置支持

在 `config.py` 中添加新提供商的配置：

```python
class Config:
    # 新AI提供商配置
    NEWAI_API_KEY: str = os.getenv("NEWAI_API_KEY", "")
    NEWAI_BASE_URL: str = os.getenv("NEWAI_BASE_URL", "")
    NEWAI_MODEL: str = os.getenv("NEWAI_MODEL", "default-model")
    # ...
    
    @classmethod
    def get_newai_config(cls) -> Dict[str, Any]:
        """获取新AI提供商配置"""
        return {
            "api_key": cls.NEWAI_API_KEY,
            "base_url": cls.NEWAI_BASE_URL,
            "model": cls.NEWAI_MODEL,
            # ...
        }
```

## 🛠️ 故障排除

### 常见问题

1. **提供商初始化失败**
   - 检查API密钥是否正确配置
   - 确认网络连接正常
   - 查看日志获取详细错误信息

2. **模型不可用**
   - 确认配置的模型名称正确
   - 检查API密钥是否有权限访问该模型
   - 查看提供商官方文档确认模型可用性

3. **响应格式错误**
   - 检查提供商实现是否正确处理响应格式
   - 确认消息格式符合提供商要求

### 日志调试

启用详细日志以便调试：

```env
LOG_LEVEL=DEBUG
```

查看日志文件：

```bash
tail -f app.log
```

## 📚 最佳实践

1. **配置管理**: 使用环境变量管理敏感配置，避免硬编码
2. **错误处理**: 实现完善的错误处理和回退机制
3. **性能优化**: 合理设置超时时间和重试策略
4. **安全性**: 定期轮换API密钥，使用HTTPS传输
5. **监控**: 监控API调用次数和响应时间，避免超出配额

## 🔗 相关链接

- [OpenAI API文档](https://platform.openai.com/docs)
- [Anthropic Claude API文档](https://docs.anthropic.com/claude/reference)
- [阿里云DashScope文档](https://help.aliyun.com/zh/dashscope)
- [百度智能云文心一言文档](https://cloud.baidu.com/doc/WENXINWORKSHOP/index.html)