# FastAPIå¼€å‘AIåº”ç”¨ï¼šå®ç°è¿ç»­å¤šè½®å¯¹è¯

æœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„å®æˆ˜é¡¹ç›®ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨FastAPIæ¡†æ¶å¼€å‘AIèŠå¤©åº”ç”¨ï¼Œé‡ç‚¹è®²è§£è¿ç»­å¤šè½®å¯¹è¯çš„å®ç°åŸç†å’Œæ ¸å¿ƒæŠ€æœ¯ã€‚å³ä½¿ä½ æ˜¯ç¼–ç¨‹æ–°æ‰‹ï¼Œä¹Ÿèƒ½è·Ÿç€æœ¬æ•™ç¨‹ä¸€æ­¥æ­¥æ„å»ºå‡ºåŠŸèƒ½å®Œæ•´çš„AIèŠå¤©åº”ç”¨ã€‚

## é¡¹ç›®æ¦‚è¿°

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨å’Œä¸€ä¸ªèªæ˜çš„AIåŠ©æ‰‹å¯¹è¯ï¼Œå®ƒä¸ä»…èƒ½å›ç­”ä½ çš„é—®é¢˜ï¼Œè¿˜èƒ½è®°ä½ä½ ä»¬ä¹‹å‰èŠè¿‡çš„å†…å®¹ã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¦æ„å»ºçš„AIèŠå¤©åº”ç”¨ï¼

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

- **è¿ç»­å¤šè½®å¯¹è¯**ï¼šAIèƒ½è®°ä½å¯¹è¯å†å²ï¼Œå°±åƒå’ŒçœŸäººèŠå¤©ä¸€æ ·è‡ªç„¶
- **å¤šè§’è‰²åˆ‡æ¢**ï¼šå¯ä»¥é€‰æ‹©ä¸åŒçš„AIè§’è‰²ï¼ˆæ™ºèƒ½åŠ©æ‰‹ã€AIè€å¸ˆã€ç¼–ç¨‹ä¸“å®¶ï¼‰
- **æµå¼å“åº”**ï¼šAIå›å¤æ—¶æœ‰æ‰“å­—æœºæ•ˆæœï¼Œä½“éªŒæ›´æµç•…
- **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒå¤šä¸ªå¯¹è¯ä¼šè¯ï¼Œå¯ä»¥éšæ—¶åˆ‡æ¢
- **Webç•Œé¢**ï¼šç®€æ´ç¾è§‚çš„èŠå¤©ç•Œé¢ï¼Œæ“ä½œç®€å•

### ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**ï¼šFastAPIï¼ˆPythonçš„ç°ä»£Webæ¡†æ¶ï¼‰
- **æ•°æ®å­˜å‚¨**ï¼šRedisï¼ˆé«˜æ€§èƒ½å†…å­˜æ•°æ®åº“ï¼‰
- **AIæ¨¡å‹**ï¼šOpenAI GPT-4o
- **å‰ç«¯**ï¼šHTML + CSS + JavaScript
- **æœåŠ¡å™¨**ï¼šUvicornï¼ˆé«˜æ€§èƒ½ASGIæœåŠ¡å™¨ï¼‰

## å¿«é€Ÿå¼€å§‹

### ğŸ“‹ ç¯å¢ƒå‡†å¤‡

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä½ çš„ç”µè„‘å·²å®‰è£…ï¼š

1. **Python 3.8+**ï¼šç¼–ç¨‹è¯­è¨€ç¯å¢ƒ
2. **Redis**ï¼šæ•°æ®å­˜å‚¨æœåŠ¡
3. **OpenAI APIå¯†é’¥**ï¼šç”¨äºè°ƒç”¨AIæ¨¡å‹

### ğŸ“ é¡¹ç›®ç»“æ„

è®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹é¡¹ç›®çš„æ–‡ä»¶ç»„ç»‡ç»“æ„ï¼š

```
fastapi-ai-chat-demo/
â”œâ”€â”€ main.py              # ğŸš€ ä¸»åº”ç”¨æ–‡ä»¶ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
â”œâ”€â”€ config.py            # âš™ï¸ é…ç½®æ–‡ä»¶ï¼ˆå‚æ•°è®¾ç½®ï¼‰
â”œâ”€â”€ start_server.py      # ğŸ”§ æœåŠ¡å™¨å¯åŠ¨è„šæœ¬
â”œâ”€â”€ requirements.txt     # ğŸ“¦ ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ .env.example         # ğŸ“ ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ static/
â”‚   â””â”€â”€ index.html      # ğŸŒ å‰ç«¯èŠå¤©ç•Œé¢
â””â”€â”€ README.md           # ğŸ“– é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

**æ–‡ä»¶è¯´æ˜ï¼š**
- `main.py`ï¼šåŒ…å«æ‰€æœ‰çš„APIæ¥å£å’Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- `config.py`ï¼šå­˜æ”¾é…ç½®å‚æ•°ï¼Œå¦‚Redisè¿æ¥ä¿¡æ¯ã€OpenAIè®¾ç½®ç­‰
- `static/index.html`ï¼šèŠå¤©ç•Œé¢çš„å‰ç«¯ä»£ç 
- `requirements.txt`ï¼šåˆ—å‡ºäº†é¡¹ç›®éœ€è¦çš„æ‰€æœ‰PythonåŒ…

### ğŸš€ å®‰è£…æ­¥éª¤

#### 1. å…‹éš†é¡¹ç›®
```bash
git clone <é¡¹ç›®åœ°å€>
cd fastapi-ai-chat-demo
```

#### 2. å®‰è£…ä¾èµ–åŒ…
```bash
pip install -r requirements.txt
```

è¿™ä¼šå®‰è£…ä»¥ä¸‹æ ¸å¿ƒåŒ…ï¼š
- `fastapi`ï¼šWebæ¡†æ¶
- `uvicorn`ï¼šASGIæœåŠ¡å™¨
- `redis`ï¼šRediså®¢æˆ·ç«¯
- `openai`ï¼šOpenAI APIå®¢æˆ·ç«¯
- `pydantic`ï¼šæ•°æ®éªŒè¯åº“

#### 3. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å…¥ä½ çš„é…ç½®ï¼š

```env
# OpenAIé…ç½®
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1

# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
```

#### 4. å¯åŠ¨RedisæœåŠ¡
```bash
# Windows
redis-server

# Linux/macOS
sudo systemctl start redis
```

#### 5. è¿è¡Œåº”ç”¨
```bash
python start_server.py
```

#### 6. è®¿é—®åº”ç”¨
æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:8000`

æ­å–œï¼ä½ çš„AIèŠå¤©åº”ç”¨å·²ç»è¿è¡Œèµ·æ¥äº†ï¼ğŸ‰

## æ ¸å¿ƒæ¶æ„

### ğŸ—ï¸ åº”ç”¨åˆå§‹åŒ–

åº”ç”¨å¯åŠ¨æ—¶éœ€è¦å®Œæˆå‡ ä¸ªå…³é”®çš„åˆå§‹åŒ–æ­¥éª¤ï¼Œå°±åƒæ­å»ºæˆ¿å­éœ€è¦å…ˆæ‰“åœ°åŸºä¸€æ ·ï¼š

**1. åˆ›å»ºWebåº”ç”¨æ¡†æ¶**

ä½¿ç”¨FastAPIåˆ›å»ºåº”ç”¨å®ä¾‹ï¼Œè¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒã€‚FastAPIä¼šè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£ï¼Œè®©å¼€å‘å’Œè°ƒè¯•å˜å¾—æ›´ç®€å•ã€‚

**2. è¿æ¥æ•°æ®å­˜å‚¨**

Rediså°±åƒåº”ç”¨çš„"å¤§è„‘è®°å¿†"ï¼Œç”¨æ¥å­˜å‚¨æ‰€æœ‰çš„å¯¹è¯å†å²ã€‚é€‰æ‹©Redisæ˜¯å› ä¸ºå®ƒé€Ÿåº¦å¿«ã€æ”¯æŒæ•°æ®è¿‡æœŸï¼Œéå¸¸é€‚åˆèŠå¤©åº”ç”¨çš„åœºæ™¯ã€‚

**3. è¿æ¥AIæœåŠ¡**

è¿™æ˜¯è¿æ¥åˆ°OpenAIçš„"æ¡¥æ¢"ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿè°ƒç”¨GPTæ¨¡å‹è¿›è¡Œæ™ºèƒ½å¯¹è¯ã€‚é€šè¿‡é…ç½®APIå¯†é’¥å’ŒåŸºç¡€URLï¼Œå»ºç«‹ä¸AIæœåŠ¡çš„é€šä¿¡é€šé“ã€‚

**4. é…ç½®AIè§’è‰²**

é€šè¿‡ä¸åŒçš„"äººè®¾"æç¤ºè¯ï¼Œè®©AIæ‰®æ¼”ä¸åŒçš„è§’è‰²ï¼š
- **æ™ºèƒ½åŠ©æ‰‹**ï¼šå‹å–„ä¸“ä¸šï¼Œé€‚åˆæ—¥å¸¸é—®ç­”
- **AIè€å¸ˆ**ï¼šè€å¿ƒæ•™å­¦ï¼Œå–„äºè§£é‡Šå¤æ‚æ¦‚å¿µ
- **ç¼–ç¨‹ä¸“å®¶**ï¼šæŠ€æœ¯ä¸“ä¸šï¼Œæä¾›ä»£ç å»ºè®®

æ¯ä¸ªè§’è‰²éƒ½æœ‰ç‹¬ç‰¹çš„å›ç­”é£æ ¼ï¼Œè®©ç”¨æˆ·è·å¾—æ›´ä¸ªæ€§åŒ–çš„ä½“éªŒã€‚

### ğŸ“‹ æ•°æ®æ¨¡å‹è®¾è®¡

åœ¨èŠå¤©åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ ‡å‡†çš„"æ¶ˆæ¯æ ¼å¼"æ¥ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ã€‚å°±åƒå¯„ä¿¡éœ€è¦æ ‡å‡†çš„ä¿¡å°æ ¼å¼ä¸€æ ·ï¼š

```python
class ChatMessage(BaseModel):
    role: str        # è°è¯´çš„è¯ï¼š"user"(ç”¨æˆ·) æˆ– "assistant"(AI)
    content: str     # è¯´äº†ä»€ä¹ˆï¼šå…·ä½“çš„å¯¹è¯å†…å®¹
    timestamp: float # ä»€ä¹ˆæ—¶å€™è¯´çš„ï¼šæ¶ˆæ¯æ—¶é—´æˆ³
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ ¼å¼ï¼Ÿ**
- **roleå­—æ®µ**ï¼šå¸®åŠ©AIåŒºåˆ†å“ªäº›æ˜¯ç”¨æˆ·çš„é—®é¢˜ï¼Œå“ªäº›æ˜¯è‡ªå·±çš„å›ç­”
- **contentå­—æ®µ**ï¼šå­˜å‚¨å®é™…çš„å¯¹è¯å†…å®¹
- **timestampå­—æ®µ**ï¼šè®°å½•æ—¶é—´ï¼Œæ–¹ä¾¿æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºå¯¹è¯

è¿™ç§æ ‡å‡†åŒ–çš„æ•°æ®æ ¼å¼è®©æˆ‘ä»¬çš„åº”ç”¨æ›´åŠ ç¨³å®šå¯é ï¼Œä¹Ÿæ–¹ä¾¿åç»­çš„åŠŸèƒ½æ‰©å±•ã€‚

### ğŸ—‚ï¸ ä¼šè¯ç®¡ç†

ä¼šè¯ç®¡ç†å°±åƒç»™æ¯ä¸ªç”¨æˆ·åˆ†é…ä¸€ä¸ª"èŠå¤©æˆ¿é—´"ï¼Œè®©AIèƒ½å¤Ÿè®°ä½æ¯ä¸ªç”¨æˆ·çš„å¯¹è¯å†å²ã€‚

#### æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

**1. ç”Ÿæˆä¼šè¯ID**
```python
def generate_session_id() -> str:
    return str(uuid.uuid4())
```
æ¯ä¸ªç”¨æˆ·å¼€å§‹èŠå¤©æ—¶ï¼Œç³»ç»Ÿä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„"æˆ¿é—´å·"ï¼ˆä¼šè¯IDï¼‰ï¼Œå°±åƒé…’åº—ç»™å®¢äººåˆ†é…æˆ¿é—´ä¸€æ ·ã€‚

**2. ä¿å­˜å¯¹è¯æ¶ˆæ¯**
```python
def save_message(user_id: str, session_id: str, message: ChatMessage):
    # å°†æ¶ˆæ¯ä¿å­˜åˆ°Redisï¼Œåƒåœ¨èŠå¤©è®°å½•æœ¬ä¸Šè®°å½•å¯¹è¯
    redis_client.lpush(conversation_key, json.dumps(message_data))
    redis_client.ltrim(conversation_key, 0, 19)  # åªä¿ç•™æœ€è¿‘20æ¡æ¶ˆæ¯
```

**3. è·å–å¯¹è¯å†å²**
```python
def get_conversation_history(user_id: str, session_id: str):
    # ä»Redisè¯»å–å†å²æ¶ˆæ¯ï¼Œè®©AIäº†è§£ä¹‹å‰èŠäº†ä»€ä¹ˆ
    return [json.loads(msg) for msg in messages]
```

#### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

- **å”¯ä¸€æ€§**ï¼šæ¯ä¸ªä¼šè¯éƒ½æœ‰ç‹¬ç‰¹çš„IDï¼Œé¿å…æ··æ·†
- **æŒä¹…åŒ–**ï¼šæ¶ˆæ¯å­˜å‚¨åœ¨Redisä¸­ï¼Œé‡å¯åº”ç”¨ä¹Ÿä¸ä¼šä¸¢å¤±
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåªä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤§
- **è‡ªåŠ¨æ¸…ç†**ï¼šè®¾ç½®7å¤©è¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨æ¸…ç†æ—§æ•°æ®

è¿™ç§è®¾è®¡è®©AIèƒ½å¤Ÿ"è®°ä½"æ¯ä¸ªç”¨æˆ·çš„å¯¹è¯å†å²ï¼Œå®ç°çœŸæ­£çš„å¤šè½®å¯¹è¯ä½“éªŒã€‚

### âš¡ æµå¼å“åº”æ ¸å¿ƒ

æµå¼å“åº”å°±åƒAIåœ¨"å®æ—¶æ‰“å­—"ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å›å¤é€å­—å‡ºç°ï¼Œè€Œä¸æ˜¯ç­‰å¾…å¾ˆä¹…åä¸€æ¬¡æ€§æ˜¾ç¤ºå…¨éƒ¨å†…å®¹ã€‚

#### ğŸ”„ å·¥ä½œæµç¨‹

**1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯**
```python
user_msg = ChatMessage(role="user", content=user_message)
save_message(session_id, user_msg)
```
é¦–å…ˆå°†ç”¨æˆ·çš„é—®é¢˜ä¿å­˜åˆ°"èŠå¤©è®°å½•æœ¬"ä¸­ã€‚

**2. è·å–å¯¹è¯å†å²**
```python
history = get_conversation_history(session_id, limit=10)
```
è¯»å–æœ€è¿‘10æ¡å¯¹è¯è®°å½•ï¼Œè®©AIäº†è§£èŠå¤©çš„ä¸Šä¸‹æ–‡ã€‚

**3. æ„å»ºå®Œæ•´å¯¹è¯**
```python
messages = [
    {"role": "system", "content": AI_ROLES[role]},  # AIè§’è‰²è®¾å®š
    *history,  # å†å²å¯¹è¯
    {"role": "user", "content": user_message}  # å½“å‰é—®é¢˜
]
```
å°†è§’è‰²è®¾å®šã€å†å²å¯¹è¯å’Œå½“å‰é—®é¢˜ç»„åˆæˆå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡ã€‚

**4. è°ƒç”¨AIæœåŠ¡**
```python
response = client.chat.completions.create(
    model="gpt-4o",
    messages=messages,
    stream=True  # å…³é”®ï¼šå¯ç”¨æµå¼å“åº”
)
```

**5. å®æ—¶è¿”å›å›å¤**
```python
for chunk in response:
    if chunk.choices[0].delta.content:
        content = chunk.choices[0].delta.content
        yield f"data: {json.dumps({'content': content})}\n\n"
```
AIæ¯ç”Ÿæˆä¸€å°æ®µæ–‡å­—ï¼Œå°±ç«‹å³å‘é€ç»™å‰ç«¯æ˜¾ç¤ºã€‚

#### ğŸ’¡ æŠ€æœ¯äº®ç‚¹

- **Server-Sent Events (SSE)**ï¼šä½¿ç”¨SSEåè®®å®ç°æœåŠ¡å™¨å‘æµè§ˆå™¨çš„å®æ—¶æ¨é€
- **å¼‚æ­¥å¤„ç†**ï¼šä¸é˜»å¡å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚
- **é”™è¯¯æ¢å¤**ï¼šç½‘ç»œä¸­æ–­æ—¶èƒ½å¤Ÿä¼˜é›…å¤„ç†
- **ä¸Šä¸‹æ–‡ä¿æŒ**ï¼šæ¯æ¬¡å¯¹è¯éƒ½èƒ½"è®°ä½"ä¹‹å‰èŠè¿‡çš„å†…å®¹

è¿™ç§è®¾è®¡è®©èŠå¤©ä½“éªŒæ›´åŠ è‡ªç„¶æµç•…ï¼Œå°±åƒå’ŒçœŸäººå¯¹è¯ä¸€æ ·ï¼

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### APIæ¥å£è®¾è®¡

æˆ‘ä»¬çš„èŠå¤©åº”ç”¨æä¾›äº†5ä¸ªæ ¸å¿ƒAPIæ¥å£ï¼Œå°±åƒä¸€ä¸ªå®Œæ•´çš„"èŠå¤©æœåŠ¡å°"ï¼š

#### ğŸ†• 1. å¼€å§‹æ–°å¯¹è¯
```python
@app.post("/chat/start")
async def start_chat(user_id: str):
    session_id = generate_session_id()
    return {"session_id": session_id, "welcome_message": "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹"}
```
**åŠŸèƒ½**ï¼šä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸€ä¸ªæ–°çš„"èŠå¤©æˆ¿é—´"ï¼Œè¿”å›æˆ¿é—´å·ï¼ˆä¼šè¯IDï¼‰ã€‚

#### ğŸ’¬ 2. æµå¼èŠå¤©
```python
@app.get("/chat/stream")
async def chat_stream(user_id: str, session_id: str, message: str, role: str = "assistant"):
    return StreamingResponse(generate_streaming_response(user_id, session_id, message, role))
```
**åŠŸèƒ½**ï¼šè¿™æ˜¯æ ¸å¿ƒæ¥å£ï¼å¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼Œè°ƒç”¨AIç”Ÿæˆå›å¤ï¼Œå¹¶å®æ—¶è¿”å›ã€‚

#### ğŸ“š 3. è·å–èŠå¤©å†å²
```python
@app.get("/chat/history")
async def get_chat_history(user_id: str, session_id: str):
    history = await get_conversation_history(user_id, session_id)
    return {"messages": history, "total": len(history)}
```
**åŠŸèƒ½**ï¼šæŸ¥çœ‹ä¹‹å‰çš„èŠå¤©è®°å½•ï¼Œå°±åƒç¿»çœ‹èŠå¤©è®°å½•æœ¬ã€‚

#### ğŸ—‘ï¸ 4. æ¸…é™¤å¯¹è¯å†å²
```python
@app.delete("/chat/history/{session_id}")
async def clear_conversation_history(session_id: str, user_id: str):
    redis_client.delete(get_conversation_key(user_id, session_id))
    return {"message": "å¯¹è¯å†å²å·²æ¸…é™¤"}
```
**åŠŸèƒ½**ï¼šæ¸…ç©ºèŠå¤©è®°å½•ï¼Œé‡æ–°å¼€å§‹å¯¹è¯ã€‚

#### ğŸ­ 5. è·å–AIè§’è‰²åˆ—è¡¨
```python
@app.get("/roles")
async def get_roles():
    return {"roles": AI_ROLES, "default_role": "assistant"}
```
**åŠŸèƒ½**ï¼šè·å–æ‰€æœ‰å¯ç”¨çš„AIè§’è‰²ï¼ˆåŠ©æ‰‹ã€è€å¸ˆã€ç¨‹åºå‘˜ç­‰ï¼‰ã€‚

#### ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

- **å‚æ•°éªŒè¯**ï¼šæ£€æŸ¥è¾“å…¥å‚æ•°çš„æœ‰æ•ˆæ€§
- **é”™è¯¯å¤„ç†**ï¼šä¼˜é›…å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
- **CORSæ”¯æŒ**ï¼šå…è®¸è·¨åŸŸè®¿é—®
- **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢æ¶æ„è¯·æ±‚ï¼ˆå¯é€‰ï¼‰

### ğŸ¨ å‰ç«¯å®ç°

å‰ç«¯å°±æ˜¯ç”¨æˆ·çœ‹åˆ°å’Œæ“ä½œçš„ç•Œé¢ï¼Œæˆ‘ä»¬ç”¨HTMLã€CSSå’ŒJavaScriptæ„å»ºäº†ä¸€ä¸ªç°ä»£åŒ–çš„èŠå¤©ç•Œé¢ã€‚

#### ğŸ—ï¸ ç•Œé¢ç»“æ„

æˆ‘ä»¬çš„èŠå¤©ç•Œé¢åŒ…å«å‡ ä¸ªä¸»è¦éƒ¨åˆ†ï¼š

```html
<div class="chat-container">
    <!-- 1. å¤´éƒ¨ï¼šæ˜¾ç¤ºæ ‡é¢˜å’Œè§’è‰²é€‰æ‹© -->
    <div class="chat-header">
        <h1>ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹</h1>
        <select id="roleSelect">
            <option value="assistant">ğŸ’¬ æ™ºèƒ½åŠ©æ‰‹</option>
            <option value="teacher">ğŸ‘¨â€ğŸ« AIè€å¸ˆ</option>
            <option value="programmer">ğŸ‘¨â€ğŸ’» ç¼–ç¨‹ä¸“å®¶</option>
        </select>
    </div>
    
    <!-- 2. æ¶ˆæ¯åŒºåŸŸï¼šæ˜¾ç¤ºå¯¹è¯å†…å®¹ -->
    <div class="messages-container" id="messagesContainer">
        <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    </div>
    
    <!-- 3. è¾“å…¥åŒºåŸŸï¼šç”¨æˆ·è¾“å…¥æ¶ˆæ¯ -->
    <div class="input-container">
        <input type="text" id="messageInput" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯...">
        <button onclick="sendMessage()">ğŸ“¤ å‘é€</button>
    </div>
    
    <!-- 4. å·¥å…·æ ï¼šå¸¸ç”¨åŠŸèƒ½æŒ‰é’® -->
    <div class="toolbar">
        <button onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤å†å²</button>
        <button onclick="newChat()">ğŸ†• æ–°å¯¹è¯</button>
    </div>
</div>
```

#### ğŸ¨ æ ·å¼è®¾è®¡ç‰¹ç‚¹

- **ç°ä»£åŒ–å¤–è§‚**ï¼šä½¿ç”¨æ¸å˜è‰²å’Œåœ†è§’è®¾è®¡
- **æ¶ˆæ¯æ°”æ³¡**ï¼šç”¨æˆ·æ¶ˆæ¯åœ¨å³è¾¹ï¼ˆè“è‰²ï¼‰ï¼ŒAIæ¶ˆæ¯åœ¨å·¦è¾¹ï¼ˆç™½è‰²ï¼‰
- **å“åº”å¼å¸ƒå±€**ï¼šåœ¨æ‰‹æœºå’Œç”µè„‘ä¸Šéƒ½èƒ½æ­£å¸¸æ˜¾ç¤º
- **åŠ¨ç”»æ•ˆæœ**ï¼šæŒ‰é’®æ‚¬åœæ•ˆæœå’Œæ‰“å­—æŒ‡ç¤ºå™¨
- **æ¸…æ™°å±‚æ¬¡**ï¼šä¸åŒåŒºåŸŸæœ‰æ˜ç¡®çš„è§†è§‰åˆ†å‰²

#### âš™ï¸ JavaScriptæ ¸å¿ƒé€»è¾‘

JavaScriptè´Ÿè´£å¤„ç†ç”¨æˆ·äº¤äº’å’Œä¸åç«¯çš„é€šä¿¡ï¼Œå°±åƒèŠå¤©åº”ç”¨çš„"å¤§è„‘"ã€‚

#### ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

**1. å¼€å§‹æ–°å¯¹è¯**
```javascript
async function startNewChat() {
    // è°ƒç”¨åç«¯APIåˆ›å»ºæ–°ä¼šè¯
    const response = await fetch('/api/chat/start', { method: 'POST' });
    const data = await response.json();
    currentSessionId = data.session_id;
    
    // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
    addMessage('assistant', 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ');
}
```

**2. å‘é€æ¶ˆæ¯**
```javascript
async function sendMessage() {
    const message = document.getElementById('messageInput').value;
    
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    addMessage('user', message);
    
    // ä½¿ç”¨EventSourceæ¥æ”¶æµå¼å“åº”
    const eventSource = new EventSource(`/api/chat/stream?session_id=${currentSessionId}&message=${message}`);
    
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.content) {
            // å®æ—¶æ˜¾ç¤ºAIå›å¤
            updateAIMessage(data.content);
        }
    };
}
```

**3. æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢**
```javascript
function addMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    // ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºåœ¨å³è¾¹ï¼ŒAIæ¶ˆæ¯æ˜¾ç¤ºåœ¨å·¦è¾¹
    const icon = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    messageDiv.innerHTML = `${icon} ${content}`;
    
    document.getElementById('messagesContainer').appendChild(messageDiv);
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
    messageDiv.scrollIntoView({ behavior: 'smooth' });
}
```

**4. æ¸…é™¤å†å²è®°å½•**
```javascript
async function clearHistory() {
    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯å†å²å—ï¼Ÿ')) {
        await fetch(`/api/chat/history/${currentSessionId}`, { method: 'DELETE' });
        document.getElementById('messagesContainer').innerHTML = '';
        addMessage('system', 'å¯¹è¯å†å²å·²æ¸…é™¤');
    }
}
```

#### ğŸ’¡ æŠ€æœ¯äº®ç‚¹

- **EventSource**ï¼šå®ç°æœåŠ¡å™¨æ¨é€ï¼Œè®©AIå›å¤å®æ—¶æ˜¾ç¤º
- **DOMæ“ä½œ**ï¼šåŠ¨æ€æ·»åŠ å’Œæ›´æ–°èŠå¤©æ¶ˆæ¯
- **ç”¨æˆ·ä½“éªŒ**ï¼šè‡ªåŠ¨æ»šåŠ¨ã€æŒ‰é’®çŠ¶æ€ç®¡ç†ã€é”™è¯¯æç¤º
- **å“åº”å¼è®¾è®¡**ï¼šé€‚é…ä¸åŒè®¾å¤‡å’Œå±å¹•å°ºå¯¸

è¿™äº›JavaScriptä»£ç è®©èŠå¤©ç•Œé¢å˜å¾—ç”ŸåŠ¨æœ‰è¶£ï¼Œç”¨æˆ·å¯ä»¥æµç•…åœ°ä¸AIè¿›è¡Œå¯¹è¯ï¼

## ğŸ”‘ å…³é”®æŠ€æœ¯è¦ç‚¹

### ğŸ’­ å¤šè½®å¯¹è¯å®ç°åŸç†

å¤šè½®å¯¹è¯çš„"ç§˜å¯†"åœ¨äºè®©AIèƒ½å¤Ÿ"è®°ä½"ä¹‹å‰èŠè¿‡çš„å†…å®¹ã€‚å°±åƒäººç±»å¯¹è¯ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ä¸Šä¸‹æ–‡æ¥ç†è§£å½“å‰çš„è¯é¢˜ã€‚

#### ğŸ§  å·¥ä½œåŸç†

æƒ³è±¡AIçš„"è®°å¿†"æ˜¯è¿™æ ·å·¥ä½œçš„ï¼š

1. **ç³»ç»Ÿè§’è‰²è®¾å®š**ï¼š"ä½ æ˜¯ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹"
2. **å†å²å¯¹è¯**ï¼š
   - ç”¨æˆ·ï¼š"æˆ‘å«å°æ˜"
   - AIï¼š"ä½ å¥½å°æ˜ï¼"
   - ç”¨æˆ·ï¼š"æˆ‘å–œæ¬¢ç¼–ç¨‹"
   - AIï¼š"ç¼–ç¨‹å¾ˆæœ‰è¶£ï¼"
3. **å½“å‰é—®é¢˜**ï¼š"ä½ è¿˜è®°å¾—æˆ‘çš„åå­—å—ï¼Ÿ"

å½“AIæ”¶åˆ°æ–°é—®é¢˜æ—¶ï¼Œå®ƒä¼šçœ‹åˆ°å®Œæ•´çš„å¯¹è¯å†å²ï¼Œæ‰€ä»¥èƒ½å›ç­”ï¼š"å½“ç„¶è®°å¾—ï¼Œä½ æ˜¯å°æ˜ï¼"

#### ğŸ”§ æŠ€æœ¯å®ç°

```python
def build_conversation_context(session_id, current_message, role):
    messages = [
        {"role": "system", "content": AI_ROLES[role]},  # è§’è‰²è®¾å®š
        *get_conversation_history(session_id),          # å†å²å¯¹è¯
        {"role": "user", "content": current_message}   # å½“å‰é—®é¢˜
    ]
    return messages
```

**å…³é”®è¦ç‚¹ï¼š**
- **ä¸Šä¸‹æ–‡çª—å£**ï¼šåªä¿ç•™æœ€è¿‘20æ¡å¯¹è¯ï¼Œé¿å…"è®°å¿†è¿‡è½½"
- **è§’è‰²ä¸€è‡´æ€§**ï¼šå§‹ç»ˆä¿æŒAIçš„äººè®¾ç‰¹å¾
- **æ ¼å¼æ ‡å‡†åŒ–**ï¼šç¡®ä¿æ•°æ®æ ¼å¼ç¬¦åˆAIæ¨¡å‹è¦æ±‚

### âš¡ æµå¼å“åº”æŠ€æœ¯

æµå¼å“åº”è®©AIçš„å›å¤åƒ"æ‰“å­—"ä¸€æ ·é€å­—å‡ºç°ï¼Œè€Œä¸æ˜¯ç­‰å¾ˆä¹…åä¸€æ¬¡æ€§æ˜¾ç¤ºå…¨éƒ¨å†…å®¹ã€‚

#### ğŸŒŠ æŠ€æœ¯åŸç†

ä¼ ç»Ÿæ–¹å¼ï¼š
```
ç”¨æˆ·å‘é€é—®é¢˜ â†’ ç­‰å¾…30ç§’ â†’ AIä¸€æ¬¡æ€§æ˜¾ç¤ºå®Œæ•´å›ç­”
```

æµå¼æ–¹å¼ï¼š
```
ç”¨æˆ·å‘é€é—®é¢˜ â†’ AIç«‹å³å¼€å§‹"æ‰“å­—" â†’ é€å­—æ˜¾ç¤ºå›ç­”è¿‡ç¨‹
```

#### ğŸ› ï¸ å®ç°æ–¹å¼

**åç«¯ï¼ˆPythonï¼‰ï¼š**
```python
def generate_streaming_response(session_id, message, role):
    # è°ƒç”¨AIæœåŠ¡ï¼Œå¯ç”¨æµå¼æ¨¡å¼
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=build_context(session_id, message, role),
        stream=True  # å…³é”®ï¼šå¯ç”¨æµå¼å“åº”
    )
    
    # é€å—è¿”å›AIç”Ÿæˆçš„å†…å®¹
    for chunk in response:
        if chunk.choices[0].delta.content:
            yield f"data: {json.dumps({'content': chunk.choices[0].delta.content})}\n\n"
```

**å‰ç«¯ï¼ˆJavaScriptï¼‰ï¼š**
```javascript
// ä½¿ç”¨EventSourceæ¥æ”¶æµå¼æ•°æ®
const eventSource = new EventSource('/api/chat/stream?...');
eventSource.onmessage = function(event) {
    const data = JSON.parse(event.data);
    // å®æ—¶æ›´æ–°AIå›å¤å†…å®¹
    updateAIMessage(data.content);
};
```

**æŠ€æœ¯ä¼˜åŠ¿ï¼š**
- **å³æ—¶åé¦ˆ**ï¼šç”¨æˆ·ç«‹å³çœ‹åˆ°AIå¼€å§‹å›å¤
- **æ›´å¥½ä½“éªŒ**ï¼šæ¨¡æ‹ŸçœŸäººå¯¹è¯çš„æ„Ÿè§‰
- **é™ä½ç„¦è™‘**ï¼šç”¨æˆ·ä¸ä¼šæ‹…å¿ƒç³»ç»Ÿå¡ä½äº†

### ğŸ’¾ æ•°æ®å­˜å‚¨ç­–ç•¥

æˆ‘ä»¬é€‰æ‹©Redisä½œä¸º"èŠå¤©è®°å½•æœ¬"ï¼Œå°±åƒä¸€ä¸ªè¶…çº§å¿«é€Ÿçš„ç¬”è®°æœ¬ã€‚

#### ğŸƒâ€â™‚ï¸ ä¸ºä»€ä¹ˆé€‰æ‹©Redisï¼Ÿ

- **é€Ÿåº¦å¿«**ï¼šå†…å­˜å­˜å‚¨ï¼Œæ¯«ç§’çº§å“åº”
- **è‡ªåŠ¨æ¸…ç†**ï¼šå¯ä»¥è®¾ç½®æ•°æ®è¿‡æœŸæ—¶é—´
- **é«˜å¯é **ï¼šæ”¯æŒæ•°æ®æŒä¹…åŒ–
- **ç®€å•æ˜“ç”¨**ï¼šæ“ä½œç®€å•ï¼Œå­¦ä¹ æˆæœ¬ä½

#### ğŸ“ å­˜å‚¨æ–¹å¼

```python
def save_message(session_id, message):
    key = f"conversation:{session_id}"
    
    # å°†æ¶ˆæ¯æ·»åŠ åˆ°åˆ—è¡¨å¤´éƒ¨
    redis_client.lpush(key, json.dumps(message_data))
    
    # åªä¿ç•™æœ€è¿‘50æ¡æ¶ˆæ¯
    redis_client.ltrim(key, 0, 49)
    
    # è®¾ç½®7å¤©åè‡ªåŠ¨åˆ é™¤
    redis_client.expire(key, 7 * 24 * 3600)
```

**å­˜å‚¨ç‰¹ç‚¹ï¼š**
- **åˆ—è¡¨ç»“æ„**ï¼šæŒ‰æ—¶é—´é¡ºåºå­˜å‚¨æ¶ˆæ¯
- **å®¹é‡æ§åˆ¶**ï¼šæœ€å¤šä¿å­˜50æ¡æ¶ˆæ¯
- **è‡ªåŠ¨è¿‡æœŸ**ï¼š7å¤©åè‡ªåŠ¨æ¸…ç†ï¼ŒèŠ‚çœç©ºé—´
- **åŸå­æ“ä½œ**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§

è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†æ€§èƒ½ï¼Œåˆé¿å…äº†æ•°æ®æ— é™å¢é•¿çš„é—®é¢˜ï¼

## æ€»ç»“

æœ¬é¡¹ç›®å±•ç¤ºäº†ä½¿ç”¨FastAPIæ„å»ºAIèŠå¤©åº”ç”¨çš„å®Œæ•´æµç¨‹ï¼Œæ ¸å¿ƒæŠ€æœ¯åŒ…æ‹¬ï¼š

- **å¼‚æ­¥ç¼–ç¨‹**ï¼šæå‡å¹¶å‘å¤„ç†èƒ½åŠ›
- **æµå¼å“åº”**ï¼šæ”¹å–„ç”¨æˆ·ä½“éªŒ
- **ä¼šè¯ç®¡ç†**ï¼šå®ç°å¤šè½®å¯¹è¯è®°å¿†
- **è§’è‰²ç³»ç»Ÿ**ï¼šæ”¯æŒå¤šæ ·åŒ–AIäº¤äº’

è¿™ä¸ªæ¶æ„å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼Œå¯ä»¥è½»æ¾æ·»åŠ ç”¨æˆ·è®¤è¯ã€å¤šæ¨¡æ€äº¤äº’ç­‰é«˜çº§åŠŸèƒ½ã€‚FastAPIçš„é«˜æ€§èƒ½å’Œå®Œå–„çš„ç±»å‹ç³»ç»Ÿä½¿å…¶æˆä¸ºæ„å»ºç°ä»£AIåº”ç”¨çš„ç†æƒ³é€‰æ‹©ã€‚