æœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„å®æˆ˜é¡¹ç›®ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨ FastAPI æ¡†æ¶å¼€å‘ AI èŠå¤©åº”ç”¨ï¼Œé‡ç‚¹è®²è§£è¿ç»­å¤šè½®å¯¹è¯çš„å®ç°åŸç†å’Œæ ¸å¿ƒæŠ€æœ¯ã€‚å³ä½¿ä½ æ˜¯ç¼–ç¨‹æ–°æ‰‹ï¼Œä¹Ÿèƒ½è·Ÿç€æœ¬æ•™ç¨‹ä¸€æ­¥æ­¥æ„å»ºå‡ºåŠŸèƒ½å®Œæ•´çš„ AI èŠå¤©åº”ç”¨ã€‚

> æœ¬é¡¹ç›®å·²ç»å¼€æºä¹‹ Githubï¼Œé¡¹ç›®åœ°å€ï¼š<https://github.com/wayn111/fastapi-ai-chat-demo>
>
> æ¸©é¦¨æç¤ºï¼šæœ¬æ–‡å…¨æ–‡çº¦ä¸€ä¸‡å­—ï¼Œçœ‹å®Œçº¦éœ€ 15åˆ†é’Ÿã€‚

## é¡¹ç›®æ¦‚è¿°

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨å’Œä¸€ä¸ªèªæ˜çš„ AI åŠ©æ‰‹å¯¹è¯ï¼Œå®ƒä¸ä»…èƒ½å›ç­”ä½ çš„é—®é¢˜ï¼Œè¿˜èƒ½è®°ä½ä½ ä»¬ä¹‹å‰èŠè¿‡çš„å†…å®¹ã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¦æ„å»ºçš„ AI èŠå¤©åº”ç”¨ï¼

### æ ¸å¿ƒåŠŸèƒ½

*   **è¿ç»­å¤šè½®å¯¹è¯**ï¼šAI èƒ½è®°ä½å¯¹è¯å†å²ï¼Œå°±åƒå’ŒçœŸäººèŠå¤©ä¸€æ ·è‡ªç„¶
*   **å¤šè§’è‰²åˆ‡æ¢**ï¼šå¯ä»¥é€‰æ‹©ä¸åŒçš„ AI è§’è‰²ï¼ˆæ™ºèƒ½åŠ©æ‰‹ã€AI è€å¸ˆã€ç¼–ç¨‹ä¸“å®¶ï¼‰
*   **æµå¼å“åº”**ï¼šAI å›å¤æ—¶æœ‰æ‰“å­—æœºæ•ˆæœï¼Œä½“éªŒæ›´æµç•…
*   **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒå¤šä¸ªå¯¹è¯ä¼šè¯ï¼Œå¯ä»¥éšæ—¶åˆ‡æ¢
*   **Web ç•Œé¢**ï¼šç®€æ´ç¾è§‚çš„èŠå¤©ç•Œé¢ï¼Œæ“ä½œç®€å•

### æŠ€æœ¯æ ˆ

*   **åç«¯æ¡†æ¶**ï¼šFastAPIï¼ˆPython çš„ç°ä»£ Web æ¡†æ¶ï¼‰
*   **æ•°æ®å­˜å‚¨**ï¼šRedisï¼ˆé«˜æ€§èƒ½å†…å­˜æ•°æ®åº“ï¼‰
*   **AI æ¨¡å‹**ï¼šæ”¯æŒ OpenAI æ¥å£è¯·æ±‚è°ƒç”¨
*   **å‰ç«¯**ï¼šHTML + CSS + JavaScript
*   **æœåŠ¡å™¨**ï¼šUvicornï¼ˆé«˜æ€§èƒ½ ASGI æœåŠ¡å™¨ï¼‰

## æ ¸å¿ƒæ¶æ„

### ğŸ—ï¸ åº”ç”¨åˆå§‹åŒ–

åº”ç”¨å¯åŠ¨æ—¶éœ€è¦å®Œæˆå‡ ä¸ªå…³é”®çš„åˆå§‹åŒ–æ­¥éª¤ï¼Œå°±åƒæ­å»ºæˆ¿å­éœ€è¦å…ˆæ‰“åœ°åŸºä¸€æ ·ï¼š

**1. åˆ›å»º Web åº”ç”¨æ¡†æ¶**

ä½¿ç”¨ FastAPI åˆ›å»ºåº”ç”¨å®ä¾‹ï¼Œè¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒã€‚FastAPI ä¼šè‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ï¼Œè®©å¼€å‘å’Œè°ƒè¯•å˜å¾—æ›´ç®€å•ã€‚

**2. è¿æ¥æ•°æ®å­˜å‚¨**

Redis å°±åƒåº”ç”¨çš„"å¤§è„‘è®°å¿†"ï¼Œç”¨æ¥å­˜å‚¨æ‰€æœ‰çš„å¯¹è¯å†å²ã€‚é€‰æ‹© Redis æ˜¯å› ä¸ºå®ƒé€Ÿåº¦å¿«ã€æ”¯æŒæ•°æ®è¿‡æœŸï¼Œéå¸¸é€‚åˆèŠå¤©åº”ç”¨çš„åœºæ™¯ã€‚

**3. è¿æ¥ AI æœåŠ¡**

è¿™æ˜¯è¿æ¥åˆ° OpenAI çš„"æ¡¥æ¢"ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿè°ƒç”¨ GPT æ¨¡å‹è¿›è¡Œæ™ºèƒ½å¯¹è¯ã€‚é€šè¿‡é…ç½® API å¯†é’¥å’ŒåŸºç¡€ URLï¼Œå»ºç«‹ä¸ AI æœåŠ¡çš„é€šä¿¡é€šé“ã€‚

**4. é…ç½® AI è§’è‰²**

é€šè¿‡ä¸åŒçš„"äººè®¾"æç¤ºè¯ï¼Œè®© AI æ‰®æ¼”ä¸åŒçš„è§’è‰²ï¼š

*   **æ™ºèƒ½åŠ©æ‰‹**ï¼šå‹å–„ä¸“ä¸šï¼Œé€‚åˆæ—¥å¸¸é—®ç­”
*   **AI è€å¸ˆ**ï¼šè€å¿ƒæ•™å­¦ï¼Œå–„äºè§£é‡Šå¤æ‚æ¦‚å¿µ
*   **ç¼–ç¨‹ä¸“å®¶**ï¼šæŠ€æœ¯ä¸“ä¸šï¼Œæä¾›ä»£ç å»ºè®®

æ¯ä¸ªè§’è‰²éƒ½æœ‰ç‹¬ç‰¹çš„å›ç­”é£æ ¼ï¼Œè®©ç”¨æˆ·è·å¾—æ›´ä¸ªæ€§åŒ–çš„ä½“éªŒã€‚

### ğŸ“‹ æ•°æ®æ¨¡å‹è®¾è®¡

åœ¨èŠå¤©åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ ‡å‡†çš„"æ¶ˆæ¯æ ¼å¼"æ¥ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ã€‚å°±åƒå¯„ä¿¡éœ€è¦æ ‡å‡†çš„ä¿¡å°æ ¼å¼ä¸€æ ·ï¼š

    classÂ ChatMessage(BaseModel):
    Â  Â  role: str Â  Â  Â  Â # è°è¯´çš„è¯ï¼š"user"(ç”¨æˆ·) æˆ– "assistant"(AI)
    Â  Â  content: str Â  Â Â # è¯´äº†ä»€ä¹ˆï¼šå…·ä½“çš„å¯¹è¯å†…å®¹
    Â  Â  timestamp: floatÂ # ä»€ä¹ˆæ—¶å€™è¯´çš„ï¼šæ¶ˆæ¯æ—¶é—´æˆ³

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ ¼å¼ï¼Ÿ**

*   **role å­—æ®µ**ï¼šå¸®åŠ© AI åŒºåˆ†å“ªäº›æ˜¯ç”¨æˆ·çš„é—®é¢˜ï¼Œå“ªäº›æ˜¯è‡ªå·±çš„å›ç­”
*   **content å­—æ®µ**ï¼šå­˜å‚¨å®é™…çš„å¯¹è¯å†…å®¹
*   **timestamp å­—æ®µ**ï¼šè®°å½•æ—¶é—´ï¼Œæ–¹ä¾¿æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºå¯¹è¯

è¿™ç§æ ‡å‡†åŒ–çš„æ•°æ®æ ¼å¼è®©æˆ‘ä»¬çš„åº”ç”¨æ›´åŠ ç¨³å®šå¯é ï¼Œä¹Ÿæ–¹ä¾¿åç»­çš„åŠŸèƒ½æ‰©å±•ã€‚

### ğŸ’­ å¤šè½®å¯¹è¯å®ç°åŸç†

å¤šè½®å¯¹è¯çš„"ç§˜å¯†"åœ¨äºè®© AI èƒ½å¤Ÿ"è®°ä½"ä¹‹å‰èŠè¿‡çš„å†…å®¹ã€‚å°±åƒäººç±»å¯¹è¯ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ä¸Šä¸‹æ–‡æ¥ç†è§£å½“å‰çš„è¯é¢˜ã€‚

#### ğŸ§  å·¥ä½œåŸç†

æƒ³è±¡ AI çš„"è®°å¿†"æ˜¯è¿™æ ·å·¥ä½œçš„ï¼š

1.  **ç³»ç»Ÿè§’è‰²è®¾å®š**ï¼š"ä½ æ˜¯ä¸€ä¸ªå‹å–„çš„ AI åŠ©æ‰‹"
2.  **å†å²å¯¹è¯**ï¼š
3.  *   ç”¨æˆ·ï¼š"æˆ‘å«å°æ˜"
    *   AIï¼š"ä½ å¥½å°æ˜ï¼"
    *   ç”¨æˆ·ï¼š"æˆ‘å–œæ¬¢ç¼–ç¨‹"
    *   AIï¼š"ç¼–ç¨‹å¾ˆæœ‰è¶£ï¼"
4.  **å½“å‰é—®é¢˜**ï¼š"ä½ è¿˜è®°å¾—æˆ‘çš„åå­—å—ï¼Ÿ"

å½“ AI æ”¶åˆ°æ–°é—®é¢˜æ—¶ï¼Œå®ƒä¼šçœ‹åˆ°å®Œæ•´çš„å¯¹è¯å†å²ï¼Œæ‰€ä»¥èƒ½å›ç­”ï¼š"å½“ç„¶è®°å¾—ï¼Œä½ æ˜¯å°æ˜ï¼"

### ğŸ—‚ï¸ ä¼šè¯ç®¡ç†

ä¼šè¯ç®¡ç†å°±åƒç»™æ¯ä¸ªç”¨æˆ·åˆ†é…ä¸€ä¸ª"èŠå¤©æˆ¿é—´"ï¼Œè®© AI èƒ½å¤Ÿè®°ä½æ¯ä¸ªç”¨æˆ·çš„å¯¹è¯å†å²ã€‚

#### æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

**1. ç”Ÿæˆä¼šè¯ ID**

    defÂ generate_session_id()Â -> str:
    Â  Â Â returnÂ str(uuid.uuid4())

æ¯ä¸ªç”¨æˆ·å¼€å§‹èŠå¤©æ—¶ï¼Œç³»ç»Ÿä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„"æˆ¿é—´å·"ï¼ˆä¼šè¯ IDï¼‰ï¼Œå°±åƒé…’åº—ç»™å®¢äººåˆ†é…æˆ¿é—´ä¸€æ ·ã€‚

**2. ä¿å­˜å¯¹è¯æ¶ˆæ¯**

    defÂ save_message(user_id: str, session_id: str, message: ChatMessage):
    Â  Â  conversation_key = get_conversation_key(user_id, session_id)
    Â  Â  redis_client.lpush(conversation_key, json.dumps(message_data))
    Â  Â  redis_client.ltrim(conversation_key,Â 0,Â 19) Â # åªä¿ç•™æœ€è¿‘20æ¡æ¶ˆæ¯

é€šè¿‡ userid + ä¼šè¯ id ç”Ÿæˆ keyï¼Œå°†æ¶ˆæ¯ä¿å­˜åˆ° Redis é˜Ÿåˆ—ä¸­

**3. è·å–å¯¹è¯å†å²**

    defÂ get_conversation_history(user_id: str, session_id: str):
    Â  Â  conversation_key = get_conversation_key(user_id, session_id)
    Â  Â  messages = redis_client.lrange(conversation_key,Â 0,Â -1)
    Â  Â Â returnÂ [json.loads(msg)Â forÂ msgÂ inÂ messages]

ä» userid + ä¼šè¯ id ç”Ÿæˆ keyï¼Œä» Redis ä¸­è¯»å–ç”¨æˆ·è¯¥ä¼šè¯çš„å†å²æ¶ˆæ¯ï¼Œè®© AI äº†è§£ä¹‹å‰èŠäº†ä»€ä¹ˆ

#### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

*   **å”¯ä¸€æ€§**ï¼šæ¯ä¸ªä¼šè¯éƒ½æœ‰ç‹¬ç‰¹çš„ IDï¼Œé¿å…æ··æ·†
*   **æŒä¹…åŒ–**ï¼šæ¶ˆæ¯å­˜å‚¨åœ¨ Redis ä¸­ï¼Œé‡å¯åº”ç”¨ä¹Ÿä¸ä¼šä¸¢å¤±
*   **æ€§èƒ½ä¼˜åŒ–**ï¼šåªä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤§
*   **è‡ªåŠ¨æ¸…ç†**ï¼šæ¯æ¬¡åªä¿ç•™æœ€è¿‘ 20 æ¡æ¶ˆæ¯ï¼Œè‡ªåŠ¨æ¸…ç†æ—§æ•°æ®

è¿™ç§è®¾è®¡è®© AI èƒ½å¤Ÿ"è®°ä½"æ¯ä¸ªç”¨æˆ·çš„å¯¹è¯å†å²ï¼Œå®ç°çœŸæ­£çš„å¤šè½®å¯¹è¯ä½“éªŒã€‚

### âš¡ æµå¼å“åº”æ ¸å¿ƒ

æµå¼å“åº”å°±åƒ AI åœ¨"å®æ—¶æ‰“å­—"ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å›å¤é€å­—å‡ºç°ï¼Œè€Œä¸æ˜¯ç­‰å¾…å¾ˆä¹…åä¸€æ¬¡æ€§æ˜¾ç¤ºå…¨éƒ¨å†…å®¹ã€‚

#### ğŸ”„ å·¥ä½œæµç¨‹

**1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯**

    user_msg = ChatMessage(role="user", content=user_message)
    save_message(session_id, user_msg)

é¦–å…ˆå°†ç”¨æˆ·çš„é—®é¢˜ä¿å­˜åˆ°"èŠå¤©è®°å½•æœ¬"ä¸­ã€‚

**2. è·å–å¯¹è¯å†å²**

    history = get_conversation_history(session_id, limit=10)

è¯»å–æœ€è¿‘ 10 æ¡å¯¹è¯è®°å½•ï¼Œè®© AI äº†è§£èŠå¤©çš„ä¸Šä¸‹æ–‡ã€‚

**3. æ„å»ºå®Œæ•´å¯¹è¯**

    messages = [
    Â  Â  {"role":Â "system",Â "content": AI_ROLES[role]}, Â # AIè§’è‰²è®¾å®š
    Â  Â  *history, Â # å†å²å¯¹è¯
    Â  Â  {"role":Â "user",Â "content": user_message} Â # å½“å‰é—®é¢˜
    ]

å°†è§’è‰²è®¾å®šã€å†å²å¯¹è¯å’Œå½“å‰é—®é¢˜ç»„åˆæˆå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡ã€‚

**4. è°ƒç”¨ AI æœåŠ¡**

    response = client.chat.completions.create(
    Â  Â  model="gpt-4o",
    Â  Â  messages=messages,
    Â  Â  stream=TrueÂ Â # å…³é”®ï¼šå¯ç”¨æµå¼å“åº”
    )

åœ¨ openAi æ¥å£è¯·æ±‚æ ¼å¼ä¸­ï¼Œstream=True è¡¨ç¤ºå¯ç”¨æµå¼å“åº”ã€‚

**5. å®æ—¶è¿”å›å›å¤**

    forÂ chunkÂ inÂ response:
    Â  Â Â ifÂ chunk.choices[0].delta.content:
    Â  Â  Â  Â  content = chunk.choices[0].delta.content
    Â  Â  Â  Â Â yieldÂ f"data:Â {json.dumps({'content': content})}\n\n"

AI æ¯ç”Ÿæˆä¸€å°æ®µæ–‡å­—ï¼Œå°±ç«‹å³å‘é€ç»™å‰ç«¯æ˜¾ç¤ºã€‚

#### ğŸ’¡ æŠ€æœ¯äº®ç‚¹

*   **Server-Sent Events (SSE)** Â ï¼šä½¿ç”¨ SSE åè®®å®ç°æœåŠ¡å™¨å‘æµè§ˆå™¨çš„å®æ—¶æ¨é€
*   **å¼‚æ­¥å¤„ç†**ï¼šä¸é˜»å¡å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚
*   **é”™è¯¯æ¢å¤**ï¼šç½‘ç»œä¸­æ–­æ—¶èƒ½å¤Ÿä¼˜é›…å¤„ç†
*   **ä¸Šä¸‹æ–‡ä¿æŒ**ï¼šæ¯æ¬¡å¯¹è¯éƒ½èƒ½"è®°ä½"ä¹‹å‰èŠè¿‡çš„å†…å®¹

è¿™ç§è®¾è®¡è®©èŠå¤©ä½“éªŒæ›´åŠ è‡ªç„¶æµç•…ï¼Œå°±åƒå’ŒçœŸäººå¯¹è¯ä¸€æ ·ï¼

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### API æ¥å£è®¾è®¡

æˆ‘ä»¬çš„èŠå¤©åº”ç”¨æä¾›äº† 5 ä¸ªæ ¸å¿ƒ API æ¥å£ï¼Œå°±åƒä¸€ä¸ªå®Œæ•´çš„"èŠå¤©æœåŠ¡å°"ï¼š

#### ğŸ†• 1. å¼€å§‹æ–°å¯¹è¯

    @app.post("/chat/start")
    asyncÂ defÂ start_chat(user_id: str):
    Â  Â  session_id = generate_session_id()
    Â  Â Â returnÂ {"session_id": session_id,Â "welcome_message":Â "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹"}

**åŠŸèƒ½**ï¼šä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸€ä¸ªæ–°çš„"èŠå¤©æˆ¿é—´"ï¼Œè¿”å›æˆ¿é—´å·ï¼ˆä¼šè¯ IDï¼‰ã€‚

#### ğŸ’¬ 2. æµå¼èŠå¤©

    @app.get("/chat/stream")
    asyncÂ defÂ chat_stream(user_id: str, session_id: str, message: str, role: str =Â "assistant"):
    Â  Â Â returnÂ StreamingResponse(generate_streaming_response(user_id, session_id, message, role))

**åŠŸèƒ½**ï¼šè¿™æ˜¯æ ¸å¿ƒæ¥å£ï¼å¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼Œè°ƒç”¨ AI ç”Ÿæˆå›å¤ï¼Œå¹¶å®æ—¶è¿”å›ã€‚

#### ğŸ“š 3. è·å–èŠå¤©å†å²

    @app.get("/chat/history")
    asyncÂ defÂ get_chat_history(user_id: str, session_id: str):
    Â  Â  history =Â awaitÂ get_conversation_history(user_id, session_id)
    Â  Â Â returnÂ {"messages": history,Â "total": len(history)}

**åŠŸèƒ½**ï¼šæŸ¥çœ‹ä¹‹å‰çš„èŠå¤©è®°å½•ï¼Œå°±åƒç¿»çœ‹èŠå¤©è®°å½•æœ¬ã€‚

#### ğŸ—‘ï¸ 4. æ¸…é™¤å¯¹è¯å†å²

    @app.delete("/chat/history/{session_id}")
    asyncÂ defÂ clear_conversation_history(session_id: str, user_id: str):
    Â  Â  redis_client.delete(get_conversation_key(user_id, session_id))
    Â  Â Â returnÂ {"message":Â "å¯¹è¯å†å²å·²æ¸…é™¤"}

**åŠŸèƒ½**ï¼šæ¸…ç©ºèŠå¤©è®°å½•ï¼Œé‡æ–°å¼€å§‹å¯¹è¯ã€‚

#### ğŸ­ 5. è·å– AI è§’è‰²åˆ—è¡¨

    @app.get("/roles")
    asyncÂ defÂ get_roles():
    Â  Â Â returnÂ {"roles": AI_ROLES,Â "default_role":Â "assistant"}

**åŠŸèƒ½**ï¼šè·å–æ‰€æœ‰å¯ç”¨çš„ AI è§’è‰²ï¼ˆåŠ©æ‰‹ã€è€å¸ˆã€ç¨‹åºå‘˜ç­‰ï¼‰ã€‚

#### ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

*   **å‚æ•°éªŒè¯**ï¼šæ£€æŸ¥è¾“å…¥å‚æ•°çš„æœ‰æ•ˆæ€§
*   **é”™è¯¯å¤„ç†**ï¼šä¼˜é›…å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
*   **CORS æ”¯æŒ**ï¼šå…è®¸è·¨åŸŸè®¿é—®
*   **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢æ¶æ„è¯·æ±‚ï¼ˆå¯é€‰ï¼‰

### ğŸ¨ å‰ç«¯å®ç°

å‰ç«¯å°±æ˜¯ç”¨æˆ·çœ‹åˆ°å’Œæ“ä½œçš„ç•Œé¢ï¼Œæˆ‘ä»¬ç”¨ HTMLã€CSS å’Œ JavaScript æ„å»ºäº†ä¸€ä¸ªç°ä»£åŒ–çš„èŠå¤©ç•Œé¢ã€‚

#### ğŸ—ï¸ ç•Œé¢ç»“æ„

æˆ‘ä»¬çš„èŠå¤©ç•Œé¢åŒ…å«å‡ ä¸ªä¸»è¦éƒ¨åˆ†ï¼š

    <divÂ class="chat-container">
    Â  Â Â <!-- 1. å¤´éƒ¨ï¼šæ˜¾ç¤ºæ ‡é¢˜å’Œè§’è‰²é€‰æ‹© -->
    Â  Â Â <divÂ class="chat-header">
    Â  Â  Â  Â Â <h1>ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹</h1>
    Â  Â  Â  Â Â <selectÂ id="roleSelect">
    Â  Â  Â  Â  Â  Â Â <optionÂ value="assistant">ğŸ’¬ æ™ºèƒ½åŠ©æ‰‹</option>
    Â  Â  Â  Â  Â  Â Â <optionÂ value="teacher">ğŸ‘¨â€ğŸ« AIè€å¸ˆ</option>
    Â  Â  Â  Â  Â  Â Â <optionÂ value="programmer">ğŸ‘¨â€ğŸ’» ç¼–ç¨‹ä¸“å®¶</option>
    Â  Â  Â  Â Â </select>
    Â  Â Â </div>

    Â  Â Â <!-- 2. æ¶ˆæ¯åŒºåŸŸï¼šæ˜¾ç¤ºå¯¹è¯å†…å®¹ -->
    Â  Â Â <divÂ class="messages-container"Â id="messagesContainer">
    Â  Â  Â  Â Â <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    Â  Â Â </div>

    Â  Â Â <!-- 3. è¾“å…¥åŒºåŸŸï¼šç”¨æˆ·è¾“å…¥æ¶ˆæ¯ -->
    Â  Â Â <divÂ class="input-container">
    Â  Â  Â  Â Â <inputÂ type="text"Â id="messageInput"Â placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯...">
    Â  Â  Â  Â Â <buttonÂ onclick="sendMessage()">ğŸ“¤ å‘é€</button>
    Â  Â Â </div>

    Â  Â Â <!-- 4. å·¥å…·æ ï¼šå¸¸ç”¨åŠŸèƒ½æŒ‰é’® -->
    Â  Â Â <divÂ class="toolbar">
    Â  Â  Â  Â Â <buttonÂ onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤å†å²</button>
    Â  Â  Â  Â Â <buttonÂ onclick="newChat()">ğŸ†• æ–°å¯¹è¯</button>
    Â  Â Â </div>
    </div>

#### ğŸ¨ æ ·å¼è®¾è®¡ç‰¹ç‚¹

*   **ç°ä»£åŒ–å¤–è§‚**ï¼šä½¿ç”¨æ¸å˜è‰²å’Œåœ†è§’è®¾è®¡
*   **æ¶ˆæ¯æ°”æ³¡**ï¼šç”¨æˆ·æ¶ˆæ¯åœ¨å³è¾¹ï¼ˆè“è‰²ï¼‰ï¼ŒAI æ¶ˆæ¯åœ¨å·¦è¾¹ï¼ˆç™½è‰²ï¼‰
*   **å“åº”å¼å¸ƒå±€**ï¼šåœ¨æ‰‹æœºå’Œç”µè„‘ä¸Šéƒ½èƒ½æ­£å¸¸æ˜¾ç¤º
*   **åŠ¨ç”»æ•ˆæœ**ï¼šæŒ‰é’®æ‚¬åœæ•ˆæœå’Œæ‰“å­—æŒ‡ç¤ºå™¨
*   **æ¸…æ™°å±‚æ¬¡**ï¼šä¸åŒåŒºåŸŸæœ‰æ˜ç¡®çš„è§†è§‰åˆ†å‰²

#### âš™ï¸ JavaScript æ ¸å¿ƒé€»è¾‘

JavaScript è´Ÿè´£å¤„ç†ç”¨æˆ·äº¤äº’å’Œä¸åç«¯çš„é€šä¿¡ï¼Œå°±åƒèŠå¤©åº”ç”¨çš„"å¤§è„‘"ã€‚

#### ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

**1. å¼€å§‹æ–°å¯¹è¯**

    asyncÂ functionÂ startNewChat()Â {
    Â  Â Â // è°ƒç”¨åç«¯APIåˆ›å»ºæ–°ä¼šè¯
    Â  Â Â constÂ response =Â awaitÂ fetch('/api/chat/start', {Â method:Â 'POST'Â });
    Â  Â Â constÂ data =Â awaitÂ response.json();
    Â  Â  currentSessionId = data.session_id;

    Â  Â Â // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
    Â  Â  addMessage('assistant',Â 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ');
    }

**2. å‘é€æ¶ˆæ¯**

    asyncÂ functionÂ sendMessage()Â {
    Â  Â Â constÂ message =Â document.getElementById('messageInput').value;

    Â  Â Â // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    Â  Â  addMessage('user', message);

    Â  Â Â // ä½¿ç”¨EventSourceæ¥æ”¶æµå¼å“åº”
    Â  Â Â constÂ eventSource =Â newÂ EventSource(`/api/chat/stream?session_id=${currentSessionId}&message=${message}`);

    Â  Â  eventSource.onmessage =Â function(event)Â {
    Â  Â  Â  Â Â constÂ data =Â JSON.parse(event.data);
    Â  Â  Â  Â Â ifÂ (data.content) {
    Â  Â  Â  Â  Â  Â Â // å®æ—¶æ˜¾ç¤ºAIå›å¤
    Â  Â  Â  Â  Â  Â  updateAIMessage(data.content);
    Â  Â  Â  Â  }
    Â  Â  };
    }

**3. æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢**

    functionÂ addMessage(role, content)Â {
    Â  Â Â constÂ messageDiv =Â document.createElement('div');
    Â  Â  messageDiv.className =Â `messageÂ ${role}`;

    Â  Â Â // ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºåœ¨å³è¾¹ï¼ŒAIæ¶ˆæ¯æ˜¾ç¤ºåœ¨å·¦è¾¹
    Â  Â Â constÂ icon = role ===Â 'user'Â ?Â 'ğŸ‘¤'Â :Â 'ğŸ¤–';
    Â  Â  messageDiv.innerHTML =Â `${icon}Â ${content}`;

    Â  Â Â document.getElementById('messagesContainer').appendChild(messageDiv);

    Â  Â Â // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
    Â  Â  messageDiv.scrollIntoView({Â behavior:Â 'smooth'Â });
    }

**4. æ¸…é™¤å†å²è®°å½•**

    asyncÂ functionÂ clearHistory()Â {
    Â  Â Â ifÂ (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯å†å²å—ï¼Ÿ')) {
    Â  Â  Â  Â Â awaitÂ fetch(`/api/chat/history/${currentSessionId}`, {Â method:Â 'DELETE'Â });
    Â  Â  Â  Â Â document.getElementById('messagesContainer').innerHTML =Â '';
    Â  Â  Â  Â  addMessage('system',Â 'å¯¹è¯å†å²å·²æ¸…é™¤');
    Â  Â  }
    }

#### ğŸ’¡ æŠ€æœ¯äº®ç‚¹

*   **EventSource**ï¼šå®ç°æœåŠ¡å™¨æ¨é€ï¼Œè®© AI å›å¤å®æ—¶æ˜¾ç¤º
*   **DOM æ“ä½œ**ï¼šåŠ¨æ€æ·»åŠ å’Œæ›´æ–°èŠå¤©æ¶ˆæ¯
*   **ç”¨æˆ·ä½“éªŒ**ï¼šè‡ªåŠ¨æ»šåŠ¨ã€æŒ‰é’®çŠ¶æ€ç®¡ç†ã€é”™è¯¯æç¤º
*   **å“åº”å¼è®¾è®¡**ï¼šé€‚é…ä¸åŒè®¾å¤‡å’Œå±å¹•å°ºå¯¸

è¿™äº› JavaScript ä»£ç è®©èŠå¤©ç•Œé¢å˜å¾—ç”ŸåŠ¨æœ‰è¶£ï¼Œç”¨æˆ·å¯ä»¥æµç•…åœ°ä¸ AI è¿›è¡Œå¯¹è¯ï¼

## å¦‚ä½•å¼€å§‹é¡¹ç›®

### ğŸ“‹ ç¯å¢ƒå‡†å¤‡

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä½ çš„ç”µè„‘å·²å®‰è£…ï¼š

1.  **Python 3.8+** Â ï¼šç¼–ç¨‹è¯­è¨€ç¯å¢ƒ
2.  **Redis**ï¼šæ•°æ®å­˜å‚¨æœåŠ¡
3.  **OpenAI API å¯†é’¥**ï¼šç”¨äºè°ƒç”¨ AI æ¨¡å‹

### ğŸ“ é¡¹ç›®ç»“æ„

è®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹é¡¹ç›®çš„æ–‡ä»¶ç»„ç»‡ç»“æ„ï¼š

    fastapi-ai-chat-demo/
    â”œâ”€â”€ main.py Â  Â  Â  Â  Â  Â  Â # ğŸš€ ä¸»åº”ç”¨æ–‡ä»¶ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
    â”œâ”€â”€ config.py Â  Â  Â  Â  Â  Â # âš™ï¸ é…ç½®æ–‡ä»¶ï¼ˆå‚æ•°è®¾ç½®ï¼‰
    â”œâ”€â”€ start_server.py Â  Â  Â # ğŸ”§ æœåŠ¡å™¨å¯åŠ¨è„šæœ¬
    â”œâ”€â”€ requirements.txt Â  Â Â # ğŸ“¦ ä¾èµ–åŒ…åˆ—è¡¨
    â”œâ”€â”€ .env.example Â  Â  Â  Â Â # ğŸ“ ç¯å¢ƒå˜é‡æ¨¡æ¿
    â”œâ”€â”€ static/
    â”‚ Â  â””â”€â”€ index.html Â  Â  Â # ğŸŒ å‰ç«¯èŠå¤©ç•Œé¢
    â””â”€â”€ README.md Â  Â  Â  Â  Â Â # ğŸ“– é¡¹ç›®è¯´æ˜æ–‡æ¡£

**æ–‡ä»¶è¯´æ˜ï¼š**

*   `main.py`ï¼šåŒ…å«æ‰€æœ‰çš„ API æ¥å£å’Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘
*   `config.py`ï¼šå­˜æ”¾é…ç½®å‚æ•°ï¼Œå¦‚ Redis è¿æ¥ä¿¡æ¯ã€OpenAI è®¾ç½®ç­‰
*   `static/index.html`ï¼šèŠå¤©ç•Œé¢çš„å‰ç«¯ä»£ç 
*   `requirements.txt`ï¼šåˆ—å‡ºäº†é¡¹ç›®éœ€è¦çš„æ‰€æœ‰ Python åŒ…

### ğŸš€ å®‰è£…æ­¥éª¤

#### 1. å…‹éš†é¡¹ç›®

    gitÂ cloneÂ git@github.com:wayn111/fastapi-ai-chat-demo.git
    cdÂ fastapi-ai-chat-demo

#### 2. å®‰è£…ä¾èµ–åŒ…

    pip install -r requirements.txt

è¿™ä¼šå®‰è£…ä»¥ä¸‹æ ¸å¿ƒåŒ…ï¼š

*   `fastapi`ï¼šWeb æ¡†æ¶
*   `uvicorn`ï¼šASGI æœåŠ¡å™¨
*   `redis`ï¼šRedis å®¢æˆ·ç«¯
*   `openai`ï¼šOpenAI API å®¢æˆ·ç«¯
*   `pydantic`ï¼šæ•°æ®éªŒè¯åº“

#### 3. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶Â `.env.example`Â ä¸ºÂ `.env`Â å¹¶å¡«å…¥ä½ çš„é…ç½®ï¼š

    # OpenAIé…ç½®
    OPENAI_API_KEY=your_openai_api_key_here
    OPENAI_BASE_URL=https://api.openai.com/v1

    # Redisé…ç½®
    REDIS_HOST=localhost
    REDIS_PORT=6379

#### 4. å¯åŠ¨ Redis æœåŠ¡

    # Windows
    redis-server

    # Linux/macOS
    sudo systemctl start redis

#### 5. è¿è¡Œåº”ç”¨

    python start_server.py

#### 6. è®¿é—®åº”ç”¨

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:8000`

![å›¾ç‰‡](https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/55e6fcc2af384967aa4c94186887189b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYd2F5bg==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiNDQwNjQ5ODMzNjk4MDEwMyJ9&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1752330791&x-orig-sign=DkikOm1f3yBLkYVYqKPz8xGjjHE%3D)

æ­å–œï¼ä½ çš„ AI èŠå¤©åº”ç”¨å·²ç»è¿è¡Œèµ·æ¥äº†ï¼ğŸ‰

## æ€»ç»“

æœ¬é¡¹ç›®å±•ç¤ºäº†ä½¿ç”¨ FastAPI æ„å»º AI èŠå¤©åº”ç”¨çš„å®Œæ•´æµç¨‹ï¼Œæ ¸å¿ƒæŠ€æœ¯åŒ…æ‹¬ï¼š

*   **å¼‚æ­¥ç¼–ç¨‹**ï¼šæå‡å¹¶å‘å¤„ç†èƒ½åŠ›
*   **æµå¼å“åº”**ï¼šæ”¹å–„ç”¨æˆ·ä½“éªŒ
*   **ä¼šè¯ç®¡ç†**ï¼šå®ç°å¤šè½®å¯¹è¯è®°å¿†
*   **è§’è‰²ç³»ç»Ÿ**ï¼šæ”¯æŒå¤šæ ·åŒ– AI äº¤äº’

è¿™ä¸ªæ¶æ„å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼Œå¯ä»¥è½»æ¾æ·»åŠ ç”¨æˆ·è®¤è¯ã€å¤šæ¨¡æ€äº¤äº’ç­‰é«˜çº§åŠŸèƒ½ã€‚FastAPI çš„é«˜æ€§èƒ½å’Œå®Œå–„çš„ç±»å‹ç³»ç»Ÿä½¿å…¶æˆä¸ºæ„å»ºç°ä»£ AI åº”ç”¨çš„ç†æƒ³é€‰æ‹©ã€‚
